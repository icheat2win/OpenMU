@using MUnique.OpenMU.Web.AdminPanel.Services;

@typeparam TItem where TItem : class

@* Only show pagination if there are multiple pages or we have more entries *@
@if (this.Page > 1 || this._hasMoreEntries)
{
    <div class="flex justify-center items-center gap-3 py-4 mb-6">
        <!-- Previous Button -->
        <Button disabled="@(this.Page <= 1 || this._isLoading)" 
                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-slate-300 disabled:cursor-not-allowed dark:bg-blue-600 dark:hover:bg-blue-700 dark:disabled:bg-slate-700 text-white rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg disabled:shadow-none" 
                @onclick=@this.GetPreviousPageAsync>
            <span class="oi oi-chevron-left text-sm" aria-hidden="true"></span>
            <span>Previous</span>
        </Button>
        
        <!-- Page Indicator -->
        <div class="inline-flex items-center gap-2 px-5 py-2 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg min-w-[120px] justify-center">
            @if (this._isLoading)
            {
                <span class="inline-block w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin" role="status" aria-hidden="true"></span>
                <span class="text-sm font-medium text-slate-600 dark:text-slate-400">Loading...</span>
            }
            else
            {
                <span class="text-sm font-bold text-slate-900 dark:text-white">Page @this.Page</span>
            }
        </div>
        
        <!-- Next Button -->
        <Button disabled="@(!this._hasMoreEntries || this._isLoading)" 
                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-slate-300 disabled:cursor-not-allowed dark:bg-blue-600 dark:hover:bg-blue-700 dark:disabled:bg-slate-700 text-white rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg disabled:shadow-none" 
                @onclick=@this.GetNextPageAsync>
            <span>Next</span>
            <span class="oi oi-chevron-right text-sm" aria-hidden="true"></span>
        </Button>
    </div>
}

<table>
    <thead>
        <tr>@TableHeader</tr>
        @if (this.FilterHeader != null)
        {
            <tr>@FilterHeader</tr>
        }
    </thead>
    <tbody>
        @if (this._items != null)
        {
            @foreach (var item in this._items)
            {
                <tr>@ItemTemplate(item)</tr>
            }
        }
        else if (this._isLoading)
        {
            <tr>Loading ...</tr>
        }
    </tbody>
    <tfoot>
        <tr>@TableFooter</tr>
    </tfoot>
</table>
@code {
    private bool _hasMoreEntries;

    private bool _isLoading;

    private IReadOnlyList<TItem>? _items;

    /// <summary>
    /// Gets or sets the table header column elements.
    /// </summary>
    [Parameter]
    public RenderFragment TableHeader { get; set; } = null!;

    /// <summary>
    /// Gets or sets the table filter header column elements.
    /// </summary>
    [Parameter]
    public RenderFragment? FilterHeader { get; set; } = null!;

    /// <summary>
    /// Gets or sets the item row template.
    /// </summary>
    [Parameter]
    public RenderFragment<TItem> ItemTemplate { get; set; } = null!;

    /// <summary>
    /// Gets or sets the table footer template.
    /// </summary>
    [Parameter]
    public RenderFragment? TableFooter { get; set; }

    /// <summary>
    /// Gets or sets the data service.
    /// </summary>
    [Inject]
    public IDataService<TItem> DataService { get; set; } = null!;

    /// <summary>
    /// Gets or sets the current page.
    /// </summary>
    public int Page { get; set; } = 1;

    /// <summary>
    /// Gets or sets the page size.
    /// </summary>
    public int PageSize { get; set; } = 20;

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await this.GetPageAsync(1);
        if (this.DataService is ISupportDataChangedNotification dataChangedNotification)
        {
            dataChangedNotification.DataChanged += async (_, __) => await this.RefreshAsync();
        }
    }

    private Task RefreshAsync()
    {
        return this.GetPageAsync(this.Page);
    }

    private Task GetNextPageAsync()
    {
        if (this._isLoading)
        {
            return Task.CompletedTask;
        }

        return this.GetPageAsync(this.Page + 1);
    }

    private Task GetPreviousPageAsync()
    {
        if (this._isLoading)
        {
            return Task.CompletedTask;
        }

        return this.GetPageAsync(this.Page - 1);
    }

    private async Task GetPageAsync(int page)
    {
        this._isLoading = true;
        try
        {
            await this.InvokeAsync(this.StateHasChanged).ConfigureAwait(false);
            var loadedItems = await this.DataService.GetAsync((page - 1) * this.PageSize, this.PageSize);
            var isRefresh = this.Page == page;
            if (isRefresh)
            {
                // when refreshing, always set the items.
                this._items = loadedItems;
            }

            if (loadedItems.Any())
            {
                this._items = loadedItems;
                this._hasMoreEntries = this._items.Count == this.PageSize;
                this.Page = page;
            }
            else
            {
                this._hasMoreEntries = false;
            }
        }
        finally
        {
            this._isLoading = false;
            await this.InvokeAsync(this.StateHasChanged).ConfigureAwait(false);
        }
    }
}
