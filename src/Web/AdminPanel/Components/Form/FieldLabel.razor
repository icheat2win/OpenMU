@using System.ComponentModel.DataAnnotations
@using System.Linq.Expressions
@using System.Reflection
@typeparam TValue

@if (!string.IsNullOrWhiteSpace(this._actualLabel))
{
    <label for="@this._fieldIdentifier.FieldName">
        <div class="flex items-start justify-between gap-2">
            <span class="font-semibold">@this._actualLabel</span>
            @if (!string.IsNullOrWhiteSpace(this._description))
            {
                <span class="oi oi-info text-cyan-500 text-xs cursor-help" title="@this._description" aria-hidden="true"></span>
            }
        </div>
        @if (!string.IsNullOrWhiteSpace(this._description))
        {
            <small class="block mt-1 text-slate-600 dark:text-slate-400 font-normal leading-relaxed">
                @this._description
            </small>
        }
    </label>
}

@code {
    private string _actualLabel = null!;
    private FieldIdentifier _fieldIdentifier;
    private string? _description;

    /// <summary>
    /// Gets or sets the text.
    /// </summary>
    [Parameter]
    public string? Text { get; set; }

    /// <summary>
    /// Gets or sets an expression that identifies the bound value.
    /// </summary>
    [Parameter]
    public Expression<Func<TValue>> ValueExpression { get; set; } = null!;

    /// <inheritdoc />
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        this._fieldIdentifier = FieldIdentifier.Create(this.ValueExpression);
        var property = this._fieldIdentifier.Model.GetType().GetProperty(this._fieldIdentifier.FieldName);
        var displayAttribute = property?.GetCustomAttribute<DisplayAttribute>();
        this._actualLabel = (string.IsNullOrWhiteSpace(this.Text) ? null : this.Text)
                            ?? displayAttribute?.GetName()
                            ?? CaptionHelper.SeparateWords(this._fieldIdentifier.FieldName);
        this._description = displayAttribute?.GetDescription();
    }
}
