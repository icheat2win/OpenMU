@using System.ComponentModel
@using MUnique.OpenMU.DataModel.Configuration
@using MUnique.OpenMU.Interfaces
@using MUnique.OpenMU.Persistence
@implements IDisposable

@if (this._isDeleted)
{
  return;
}

<div class="@GetServerCardClasses() rounded-xl p-6 transition-all duration-300 hover:shadow-2xl border">
    <!-- Server Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
        <!-- Left: Icon and Info -->
        <div class="flex items-center gap-4">
            <!-- Server Icon with Status Indicator -->
            <div class="relative">
                <div class="@GetServerIconClasses() w-14 h-14 rounded-xl flex items-center justify-center text-2xl shadow-lg">
                    @GetServerTypeIcon()
                </div>
                @if (this.Server.ServerState == ServerState.Started)
                {
                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-emerald-500 rounded-full border-2 border-white animate-pulse"></div>
                }
                else if (this.Server.ServerState == ServerState.Starting || this.Server.ServerState == ServerState.Stopping)
                {
                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-amber-500 rounded-full border-2 border-white animate-pulse"></div>
                }
                else if (this.Server.ServerState == ServerState.Timeout)
                {
                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white"></div>
                }
            </div>
            
            <!-- Server Info -->
            <div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">
                    @switch (this.Server.Type)
                    {
                        case ServerType.GameServer:
                            <NavLink href="@("edit-config/" + typeof(GameServerDefinition).FullName + "/" + this.Server.ConfigurationId)" 
                                     class="hover:text-cyan-500 transition-colors">@this.Server.Description</NavLink>
                            break;
                        case ServerType.ConnectServer:
                            <NavLink href="@("edit-connectionServer/" + this.Server.ConfigurationId)" 
                                     class="hover:text-cyan-500 transition-colors">@this.Server.Description</NavLink>
                            break;
                        case ServerType.ChatServer:
                            <NavLink href="@("edit-config/" + typeof(ChatServerDefinition).FullName + "/" + this.Server.ConfigurationId)" 
                                     class="hover:text-cyan-500 transition-colors">@this.Server.Description</NavLink>
                            break;
                        default:
                            @this.Server.Description
                            break;
                    }
                </h3>
                <div class="flex flex-wrap items-center gap-2">
                    <span class="px-3 py-1 bg-slate-100 text-slate-700 text-sm font-medium rounded-full">
                        @GetServerTypeText()
                    </span>
                    <span class="@GetStatusBadgeClasses() px-3 py-1 text-sm font-medium rounded-full flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full @GetStatusDotClasses()"></span>
                        @GetStateCaption()
                    </span>
                </div>
            </div>
        </div>

        <!-- Right: Map Link for Game Servers -->
        @if (this.Server.Type == ServerType.GameServer)
        {
            <div>
                <a href="/gameServer/@(this.Server.Id)/" target="_blank" 
                   class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white rounded-lg font-medium shadow-lg hover:shadow-xl transition-all">
                    <span class="text-lg">🗺️</span>
                    <span>View Map</span>
                </a>
            </div>
        }
    </div>

    <!-- Server Stats -->
    <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-lg p-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">👥</span>
                <div>
                    <div class="text-2xl font-bold text-slate-900">@this.Server.CurrentConnections</div>
                    <div class="text-sm text-slate-600">Online</div>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-lg p-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">📊</span>
                <div>
                    <div class="text-2xl font-bold text-slate-900">@(this.Server.MaximumConnections < int.MaxValue ? this.Server.MaximumConnections.ToString() : "∞")</div>
                    <div class="text-sm text-slate-600">Capacity</div>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-lg p-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">⚡</span>
                <div>
                    <div class="text-2xl font-bold text-slate-900">@GetConnectionPercentage()%</div>
                    <div class="text-sm text-slate-600">Usage</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    @if (this.Server.CurrentConnections > 0 && this.Server.MaximumConnections < int.MaxValue)
    {
        <div class="mb-6 bg-slate-200 rounded-full h-2 overflow-hidden">
            <div class="@GetProgressBarClasses() h-full rounded-full transition-all duration-500" 
                 style="width: @GetConnectionPercentage()%"></div>
        </div>
    }

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-3">
        @if (this.Server.ServerState == ServerState.Started)
        {
            <button type="button" 
                    class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-red-500 to-rose-500 hover:from-red-600 hover:to-rose-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all" 
                    title="Stop Server" 
                    @onclick="this.OnPauseClickAsync">
                <span class="text-lg">⏹️</span>
                <span>Stop Server</span>
            </button>
            @if (this.Server.Type is ServerType.GameServer or ServerType.ConnectServer)
            {
                <button type="button" 
                        class="flex items-center gap-2 px-6 py-3 bg-slate-300 text-slate-500 rounded-lg font-semibold cursor-not-allowed" 
                        title="Cannot remove running server" 
                        disabled>
                    <span class="text-lg">🗑️</span>
                    <span>Remove</span>
                </button>
            }
        }
        else if (this.Server.ServerState == ServerState.Stopped)
        {
            <button type="button" 
                    class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all" 
                    title="Start Server" 
                    @onclick="this.OnStartClickAsync">
                <span class="text-lg">▶️</span>
                <span>Start Server</span>
            </button>
            @if (this.Server.Type is ServerType.GameServer or ServerType.ConnectServer)
            {
                <button type="button" 
                        class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-red-500 to-rose-500 hover:from-red-600 hover:to-rose-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all" 
                        title="Remove Server" 
                        @onclick="this.OnDeleteServerClickAsync">
                    <span class="text-lg">🗑️</span>
                    <span>Remove Server</span>
                </button>
            }
        }
        else
        {
            <button type="button" 
                    class="flex items-center gap-2 px-6 py-3 bg-amber-500 text-white rounded-lg font-semibold cursor-not-allowed" 
                    disabled>
                <span class="text-lg">⏳</span>
                <span>@GetStateCaption()</span>
            </button>
        }
    </div>
</div>

@code {

    private bool _isDeleted;

    /// <summary>
    /// Gets or sets the server which is shown in this component.
    /// </summary>
    [Parameter]
    public IManageableServer Server { get; set; } = null!;

    /// <summary>
    /// Gets or sets the <see cref="IGameServerInstanceManager"/>.
    /// </summary>
    [Inject]
    public IGameServerInstanceManager GameServerInstanceManager { get; set; } = null!;

    /// <summary>
    /// Gets or sets the <see cref="IConnectServerInstanceManager"/>.
    /// </summary>
    [Inject]
    public IConnectServerInstanceManager ConnectServerInstanceManager { get; set; } = null!;

    /// <summary>
    /// Gets or sets the <see cref="IPersistenceContextProvider"/>.
    /// </summary>
    [Inject]
    public IPersistenceContextProvider ContextProvider { get; set; } = null!;

    /// <summary>
    /// Gets or sets the data source for the game configuration.
    /// </summary>
    [Inject]
    public IDataSource<GameConfiguration> DataSource { get; set; } = null!;

    /// <summary>
    /// Gets or sets the modal service.
    /// </summary>
    [Inject]
    public IModalService ModalService { get; set; } = null!;

    /// <inheritdoc />
    public void Dispose()
    {
        this.Server.PropertyChanged -= this.OnServerPropertyChanged;
    }

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        base.OnInitialized();
        this.Server.PropertyChanged += this.OnServerPropertyChanged;
    }

    /// <inheritdoc />
    protected override void OnParametersSet()
    {
      base.OnParametersSet();
      this._isDeleted = false;
    }

    [System.Diagnostics.CodeAnalysis.SuppressMessage("Usage", "VSTHRD100:Avoid async void methods", Justification = "Catching all Exceptions.")]
    private async void OnServerPropertyChanged(object? sender, PropertyChangedEventArgs eventArgs)
    {
        try
        {
            await this.InvokeAsync(this.StateHasChanged).ConfigureAwait(false);
        }
        catch
        {
            // must be catched because it's an async void method.
        }

    }

    private string GetActionClass()
    {
        if (this.Server.ServerState == ServerState.Started)
            return "btn-success";
        else
            return "btn-warning";
    }

    private async Task OnPauseClickAsync()
    {
        await this.Server.StopAsync(default);
    }

    private async Task OnStartClickAsync()
    {
      await this.Server.StartAsync(default);
    }

    private async Task OnDeleteServerClickAsync()
    {
      if (this.Server.Type is not (ServerType.GameServer or ServerType.ConnectServer))
      {
        return;
      }

      var dialogResult = await this.ModalService.ShowQuestionAsync(
        "Remove Server",
        "The server will be deleted from the database. Are you sure to proceed?");
      if (!dialogResult)
      {
        return;
      }

      await this.Server.StopAsync(default);
      if (this.Server.Type == ServerType.GameServer)
      {
        await this.GameServerInstanceManager.RemoveGameServerAsync((byte)this.Server.Id);
        await this.DeleteAsync<GameServerDefinition>(s => s.ServerID == this.Server.Id);
      }
      else
      {
        await this.ConnectServerInstanceManager.RemoveConnectServerAsync(this.Server.ConfigurationId);
        await this.DeleteAsync<ConnectServerDefinition>(s => s.ConfigurationId == this.Server.ConfigurationId);
      }
    }

    private async ValueTask DeleteAsync<T>(Predicate<T> predicate)
      where T : class
    {
      var gameConfiguration = await this.DataSource.GetOwnerAsync().ConfigureAwait(false);
      using var context = this.ContextProvider.CreateNewTypedContext(typeof(T), true, gameConfiguration);
      var definitions = await context.GetAsync<T>().ConfigureAwait(false);
      var definition = definitions.FirstOrDefault(def => predicate(def));

      if (definition is not null)
      {
        await context.DeleteAsync(definition).ConfigureAwait(false);
        await context.SaveChangesAsync().ConfigureAwait(false);
        this._isDeleted = true;
      }
    }

    private string GetStateCaption()
    {
        switch (this.Server.ServerState)
        {
            case ServerState.Stopped:
                return "Stopped";
            case ServerState.Starting:
                return "Starting ...";
            case ServerState.Started:
                return "Started";
            case ServerState.Stopping:
                return "Stopping ...";
            case ServerState.Timeout:
                return "Timeout";
        }

        return string.Empty;
    }

    private string GetServerCardClasses()
    {
        return this.Server.ServerState switch
        {
            ServerState.Started => "bg-white border-emerald-200 shadow-lg shadow-emerald-500/20",
            ServerState.Starting => "bg-white border-amber-200 shadow-lg shadow-amber-500/20",
            ServerState.Stopping => "bg-white border-amber-200 shadow-lg shadow-amber-500/20",
            ServerState.Stopped => "bg-white border-slate-200 shadow-lg",
            ServerState.Timeout => "bg-white border-red-200 shadow-lg shadow-red-500/20",
            _ => "bg-white border-slate-200 shadow-lg"
        };
    }

    private string GetServerIconClasses()
    {
        return this.Server.Type switch
        {
            ServerType.GameServer => "bg-gradient-to-br from-blue-500 to-cyan-500 text-white",
            ServerType.ConnectServer => "bg-gradient-to-br from-purple-500 to-pink-500 text-white",
            ServerType.ChatServer => "bg-gradient-to-br from-emerald-500 to-green-500 text-white",
            _ => "bg-gradient-to-br from-slate-500 to-slate-600 text-white"
        };
    }

    private string GetStatusBadgeClasses()
    {
        return this.Server.ServerState switch
        {
            ServerState.Started => "bg-emerald-100 text-emerald-700",
            ServerState.Starting => "bg-amber-100 text-amber-700",
            ServerState.Stopping => "bg-amber-100 text-amber-700",
            ServerState.Stopped => "bg-slate-100 text-slate-700",
            ServerState.Timeout => "bg-red-100 text-red-700",
            _ => "bg-slate-100 text-slate-700"
        };
    }

    private string GetStatusDotClasses()
    {
        return this.Server.ServerState switch
        {
            ServerState.Started => "bg-emerald-500 animate-pulse",
            ServerState.Starting => "bg-amber-500 animate-pulse",
            ServerState.Stopping => "bg-amber-500 animate-pulse",
            ServerState.Stopped => "bg-slate-400",
            ServerState.Timeout => "bg-red-500",
            _ => "bg-slate-400"
        };
    }

    private string GetProgressBarClasses()
    {
        var percentage = GetConnectionPercentage();
        return percentage switch
        {
            >= 90 => "bg-gradient-to-r from-red-500 to-rose-500",
            >= 70 => "bg-gradient-to-r from-amber-500 to-orange-500",
            >= 50 => "bg-gradient-to-r from-yellow-500 to-amber-500",
            _ => "bg-gradient-to-r from-emerald-500 to-green-500"
        };
    }

    private string GetServerTypeIcon()
    {
        return this.Server.Type switch
        {
            ServerType.GameServer => "🎮",
            ServerType.ConnectServer => "🔗",
            ServerType.ChatServer => "💬",
            _ => "🖥️"
        };
    }

    private string GetServerTypeText()
    {
        return this.Server.Type switch
        {
            ServerType.GameServer => "Game Server",
            ServerType.ConnectServer => "Connect Server",
            ServerType.ChatServer => "Chat Server",
            _ => "Unknown"
        };
    }

    private int GetConnectionPercentage()
    {
        if (this.Server.MaximumConnections >= int.MaxValue || this.Server.MaximumConnections == 0)
        {
            return 0;
        }
        
        return (int)((double)this.Server.CurrentConnections / this.Server.MaximumConnections * 100);
    }
}
