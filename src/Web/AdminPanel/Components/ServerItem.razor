@using System.ComponentModel
@using MUnique.OpenMU.DataModel.Configuration
@using MUnique.OpenMU.Interfaces
@using MUnique.OpenMU.Persistence
@implements IDisposable

@if (this._isDeleted)
{
  return;
}

<div class="modern-server-card @GetServerStatusClass()">
    <div class="server-card-main">
        <div class="server-header-section">
            <div class="server-icon-wrapper">
                <div class="server-icon @GetServerTypeClass()">
                    @GetServerTypeIcon()
                </div>
                <div class="status-pulse @GetServerStatusPulseClass()"></div>
            </div>
            
            <div class="server-info-section">
                <h3 class="server-title">
                    @switch (this.Server.Type)
                    {
                        case ServerType.GameServer:
                            <NavLink href="@("edit-config/" + typeof(GameServerDefinition).FullName + "/" + this.Server.ConfigurationId)">@this.Server.Description</NavLink>
                            break;
                        case ServerType.ConnectServer:
                            <NavLink href="@("edit-connectionServer/" + this.Server.ConfigurationId)">@this.Server.Description</NavLink>
                            break;
                        case ServerType.ChatServer:
                            <NavLink href="@("edit-config/" + typeof(ChatServerDefinition).FullName + "/" + this.Server.ConfigurationId)">@this.Server.Description</NavLink>
                            break;
                        default:
                            @this.Server.Description
                            break;
                    }
                </h3>
                <div class="server-badges">
                    <span class="badge badge-type">@GetServerTypeText()</span>
                    <span class="badge badge-status @GetServerStatusBadgeClass()">
                        <span class="badge-dot"></span>
                        @GetStateCaption()
                    </span>
                </div>
            </div>

            @if (this.Server.Type == ServerType.GameServer)
            {
                <div class="server-quick-link">
                    <a href="/gameServer/@(this.Server.Id)/" target="_blank" class="map-link" title="View Map">
                        <span class="map-icon">🗺️</span>
                        <span>View Map</span>
                    </a>
                </div>
            }
        </div>

        <div class="server-stats-section">
            <div class="stat-box">
                <div class="stat-icon">👥</div>
                <div class="stat-content">
                    <div class="stat-value">@this.Server.CurrentConnections</div>
                    <div class="stat-label">Online</div>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                    <div class="stat-value">@(this.Server.MaximumConnections < int.MaxValue ? this.Server.MaximumConnections.ToString() : "∞")</div>
                    <div class="stat-label">Capacity</div>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-icon">⚡</div>
                <div class="stat-content">
                    <div class="stat-value">@GetConnectionPercentage()%</div>
                    <div class="stat-label">Usage</div>
                </div>
            </div>
        </div>

        <div class="server-actions-section">
            @if (this.Server.ServerState == ServerState.Started)
            {
                <button type="button" class="action-btn action-btn-stop" title="Stop Server" @onclick="this.OnPauseClickAsync">
                    <span class="action-icon">⏹️</span>
                    <span>Stop</span>
                </button>
                @if (this.Server.Type is ServerType.GameServer or ServerType.ConnectServer)
                {
                    <button type="button" class="action-btn action-btn-disabled" title="Cannot remove running server" disabled>
                        <span class="action-icon">🗑️</span>
                        <span>Remove</span>
                    </button>
                }
            }
            else if (this.Server.ServerState == ServerState.Stopped)
            {
                <button type="button" class="action-btn action-btn-start" title="Start Server" @onclick="this.OnStartClickAsync">
                    <span class="action-icon">▶️</span>
                    <span>Start</span>
                </button>
                @if (this.Server.Type is ServerType.GameServer or ServerType.ConnectServer)
                {
                    <button type="button" class="action-btn action-btn-remove" title="Remove Server" @onclick="this.OnDeleteServerClickAsync">
                        <span class="action-icon">🗑️</span>
                        <span>Remove</span>
                    </button>
                }
            }
            else
            {
                <button type="button" class="action-btn action-btn-disabled" disabled>
                    <span class="action-icon">⏳</span>
                    <span>@GetStateCaption()</span>
                </button>
            }
        </div>
    </div>

    @if (this.Server.CurrentConnections > 0 && this.Server.MaximumConnections < int.MaxValue)
    {
        <div class="server-progress">
            <div class="progress-bar" style="width: @GetConnectionPercentage()%"></div>
        </div>
    }
</div>

@code {

    private bool _isDeleted;

    /// <summary>
    /// Gets or sets the server which is shown in this component.
    /// </summary>
    [Parameter]
    public IManageableServer Server { get; set; } = null!;

    /// <summary>
    /// Gets or sets the <see cref="IGameServerInstanceManager"/>.
    /// </summary>
    [Inject]
    public IGameServerInstanceManager GameServerInstanceManager { get; set; } = null!;

    /// <summary>
    /// Gets or sets the <see cref="IConnectServerInstanceManager"/>.
    /// </summary>
    [Inject]
    public IConnectServerInstanceManager ConnectServerInstanceManager { get; set; } = null!;

    /// <summary>
    /// Gets or sets the <see cref="IPersistenceContextProvider"/>.
    /// </summary>
    [Inject]
    public IPersistenceContextProvider ContextProvider { get; set; } = null!;

    /// <summary>
    /// Gets or sets the data source for the game configuration.
    /// </summary>
    [Inject]
    public IDataSource<GameConfiguration> DataSource { get; set; } = null!;

    /// <summary>
    /// Gets or sets the modal service.
    /// </summary>
    [Inject]
    public IModalService ModalService { get; set; } = null!;

    /// <inheritdoc />
    public void Dispose()
    {
        this.Server.PropertyChanged -= this.OnServerPropertyChanged;
    }

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        base.OnInitialized();
        this.Server.PropertyChanged += this.OnServerPropertyChanged;
    }

    /// <inheritdoc />
    protected override void OnParametersSet()
    {
      base.OnParametersSet();
      this._isDeleted = false;
    }

    [System.Diagnostics.CodeAnalysis.SuppressMessage("Usage", "VSTHRD100:Avoid async void methods", Justification = "Catching all Exceptions.")]
    private async void OnServerPropertyChanged(object? sender, PropertyChangedEventArgs eventArgs)
    {
        try
        {
            await this.InvokeAsync(this.StateHasChanged).ConfigureAwait(false);
        }
        catch
        {
            // must be catched because it's an async void method.
        }

    }

    private string GetActionClass()
    {
        if (this.Server.ServerState == ServerState.Started)
            return "btn-success";
        else
            return "btn-warning";
    }

    private async Task OnPauseClickAsync()
    {
        await this.Server.StopAsync(default);
    }

    private async Task OnStartClickAsync()
    {
      await this.Server.StartAsync(default);
    }

    private async Task OnDeleteServerClickAsync()
    {
      if (this.Server.Type is not (ServerType.GameServer or ServerType.ConnectServer))
      {
        return;
      }

      var dialogResult = await this.ModalService.ShowQuestionAsync(
        "Remove Server",
        "The server will be deleted from the database. Are you sure to proceed?");
      if (!dialogResult)
      {
        return;
      }

      await this.Server.StopAsync(default);
      if (this.Server.Type == ServerType.GameServer)
      {
        await this.GameServerInstanceManager.RemoveGameServerAsync((byte)this.Server.Id);
        await this.DeleteAsync<GameServerDefinition>(s => s.ServerID == this.Server.Id);
      }
      else
      {
        await this.ConnectServerInstanceManager.RemoveConnectServerAsync(this.Server.ConfigurationId);
        await this.DeleteAsync<ConnectServerDefinition>(s => s.ConfigurationId == this.Server.ConfigurationId);
      }
    }

    private async ValueTask DeleteAsync<T>(Predicate<T> predicate)
      where T : class
    {
      var gameConfiguration = await this.DataSource.GetOwnerAsync().ConfigureAwait(false);
      using var context = this.ContextProvider.CreateNewTypedContext(typeof(T), true, gameConfiguration);
      var definitions = await context.GetAsync<T>().ConfigureAwait(false);
      var definition = definitions.FirstOrDefault(def => predicate(def));

      if (definition is not null)
      {
        await context.DeleteAsync(definition).ConfigureAwait(false);
        await context.SaveChangesAsync().ConfigureAwait(false);
        this._isDeleted = true;
      }
    }

    private string GetStateCaption()
    {
        switch (this.Server.ServerState)
        {
            case ServerState.Stopped:
                return "Stopped";
            case ServerState.Starting:
                return "Starting ...";
            case ServerState.Started:
                return "Started";
            case ServerState.Stopping:
                return "Stopping ...";
            case ServerState.Timeout:
                return "Timeout";
        }

        return string.Empty;
    }

    private string GetServerStatusClass()
    {
        return this.Server.ServerState switch
        {
            ServerState.Started => "server-started",
            ServerState.Starting => "server-starting",
            ServerState.Stopping => "server-stopping",
            ServerState.Stopped => "server-stopped",
            ServerState.Timeout => "server-timeout",
            _ => string.Empty
        };
    }

    private string GetServerStatusBadgeColor()
    {
        return this.Server.ServerState switch
        {
            ServerState.Started => "success",
            ServerState.Starting => "warning",
            ServerState.Stopping => "warning",
            ServerState.Stopped => "default",
            ServerState.Timeout => "danger",
            _ => "default"
        };
    }

    private string GetServerTypeIcon()
    {
        return this.Server.Type switch
        {
            ServerType.GameServer => "🎮",
            ServerType.ConnectServer => "🔗",
            ServerType.ChatServer => "💬",
            _ => "🖥️"
        };
    }

    private string GetServerTypeText()
    {
        return this.Server.Type switch
        {
            ServerType.GameServer => "Game Server",
            ServerType.ConnectServer => "Connect Server",
            ServerType.ChatServer => "Chat Server",
            _ => "Unknown"
        };
    }

    private string GetServerTypeClass()
    {
        return this.Server.Type switch
        {
            ServerType.GameServer => "server-icon-game",
            ServerType.ConnectServer => "server-icon-connect",
            ServerType.ChatServer => "server-icon-chat",
            _ => "server-icon-default"
        };
    }

    private string GetServerStatusPulseClass()
    {
        return this.Server.ServerState switch
        {
            ServerState.Started => "pulse-active",
            ServerState.Starting => "pulse-warning",
            ServerState.Stopping => "pulse-warning",
            ServerState.Timeout => "pulse-danger",
            _ => string.Empty
        };
    }

    private string GetServerStatusBadgeClass()
    {
        return this.Server.ServerState switch
        {
            ServerState.Started => "badge-success",
            ServerState.Starting => "badge-warning",
            ServerState.Stopping => "badge-warning",
            ServerState.Stopped => "badge-secondary",
            ServerState.Timeout => "badge-danger",
            _ => "badge-secondary"
        };
    }

    private int GetConnectionPercentage()
    {
        if (this.Server.MaximumConnections >= int.MaxValue || this.Server.MaximumConnections == 0)
        {
            return 0;
        }
        
        return (int)((double)this.Server.CurrentConnections / this.Server.MaximumConnections * 100);
    }
}
