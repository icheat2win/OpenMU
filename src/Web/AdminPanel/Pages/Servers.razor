@page "/servers"
@using MUnique.OpenMU.Interfaces
@using System.ComponentModel

@implements IDisposable;

<PageTitle>OpenMU: Servers</PageTitle>
<Breadcrumb IsFirstFromRoot="true" Caption="Servers"/>

<div class="page-header">
    <div class="page-title-group">
        <h1>🖥️ Server Management</h1>
        <p class="text-muted">Manage and monitor all OpenMU servers</p>
    </div>
    @if (this.ServerInstanceManager is not null && _servers != null)
    {
        <div class="page-actions">
            @if (this._isRestarting)
            {
                <button type="button" class="btn btn-warning" disabled="disabled">
                    <div class="spinner"></div>
                    <span>Restarting...</span>
                </button>
            }
            else
            {
                <button type="button" class="btn btn-warning" @onclick="this.OnReloadAndRestartClickAsync">
                    <span class="btn-icon">🔄</span> Reload & Restart All
                </button>
            }
        </div>
    }
</div>

@if (_servers == null)
{
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Loading servers...</p>
    </div>
}
else
{
<div class="servers-page">
    <div class="servers-header">
        <SectionCard Title="Server Overview" Icon="📊">
            <TotalOnlineCounter Servers=@_servers />
        </SectionCard>
    </div>

    <div class="servers-actions">
        <ModernCard Title="Quick Actions" Icon="⚡" CssClass="actions-card">
            <div class="action-buttons">
                <NavLink class="btn btn-primary" href="create-game-server">
                    <span class="btn-icon">🎮</span> Create Game Server
                </NavLink>
                <NavLink class="btn btn-primary" href="create-connect-server">
                    <span class="btn-icon">🔗</span> Create Connect Server
                </NavLink>
            </div>
        </ModernCard>
    </div>

    <div class="servers-list">
        @foreach (var server in this._servers.OrderBy(s => s.Type).ThenBy(s => s.Description))
        {
            <ServerItem Server=@server/>
        }
    </div>
</div>
}

@code {
    private IList<IManageableServer>? _servers;

    private bool _isRestarting;

    /// <summary>
    /// Gets or sets the <see cref="IServerProvider"/>.
    /// </summary>
    [Inject]
    public IServerProvider ServerProvider { get; set; } = null!;

    /// <summary>
    /// Gets or sets the <see cref="IGameServerInstanceManager"/>.
    /// </summary>
    [Inject]
    public IGameServerInstanceManager? ServerInstanceManager { get; set; }

    /// <inheritdoc />
    public void Dispose()
    {
        this.ServerProvider.PropertyChanged -= this.OnServersChanged;
    }

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        base.OnInitialized();
        this._servers = this.ServerProvider.Servers;
        this.ServerProvider.PropertyChanged += this.OnServersChanged;
    }

    private void OnServersChanged(object? sender, PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(IServerProvider.Servers))
        {
            this._servers = this.ServerProvider.Servers;
            this.InvokeAsync(this.StateHasChanged);
        }
    }

    private async Task OnReloadAndRestartClickAsync()
    {
      this._isRestarting = true;
      try
      {
            await this.ServerInstanceManager!.RestartAllAsync(false);
      }
      finally
      {
        this._isRestarting = false;
      }
    }
}
