@page "/gameServer/{gameServerId:int}/map/{mapId:guid}"
@implements IDisposable

@using MUnique.OpenMU.Web.Map.Components
@using MUnique.OpenMU.Web.Map
@using MUnique.OpenMU.Interfaces
@using MUnique.OpenMU.GameLogic

<PageTitle>OpenMU: Live Map</PageTitle>
<Breadcrumb Caption="Live Map"/>

<!-- Page Container -->
<div class="min-h-screen bg-white dark:bg-slate-900 py-6 px-4">
    @if (this._gameServer is not null)
    {
        <!-- Navigation Breadcrumb -->
        <div class="mb-6 flex items-center space-x-2 text-sm">
            <NavLink href="" Match="NavLinkMatch.All" 
                     class="text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 font-medium transition-colors duration-200">
                <span class="flex items-center space-x-1">
                    <span class="oi oi-home"></span>
                    <span>All Servers</span>
                </span>
            </NavLink>
            <span class="text-slate-400 dark:text-slate-500">/</span>
            <span class="text-slate-700 dark:text-slate-300 font-semibold">@this._map?.MapName</span>
        </div>

        <!-- Map Container -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden border border-slate-200 dark:border-slate-700">
            <CascadingValue Value="@_gameServer">
                <Map Server="@_gameServer" MapId="@MapId"></Map>
            </CascadingValue>
        </div>
    }
</div>

@code {
    internal const string LiveMapRoute = "map/";

    private IGameMapInfo? _map;

    private IObservableGameServer? _gameServer;

    /// <summary>
    /// Gets or sets the server id on which the map is hosted.
    /// </summary>
    [Inject]
    public IList<IManageableServer> Servers { get; set; } = null!;

    /// <summary>
    /// Gets or sets the map id.
    /// </summary>
    [Parameter]
    public Guid MapId { get; set; }

    /// <summary>
    /// Gets or sets the game server id/index.
    /// </summary>
    [Parameter]
    public int GameServerId { get; set; }

    /// <inheritdoc />
    public void Dispose()
    {
        (this._gameServer as IDisposable)?.Dispose();
    }

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        var gameServer = this.Servers.OfType<IGameServer>().First(gs => gs.Id == this.GameServerId);
        var context = (gameServer as IGameServerContextProvider)?.Context ?? throw new InvalidOperationException("This map page just works in a All-In-One deployment.");
        var adapter = new ObservableGameServerAdapter(context);
        await adapter.InitializeAsync();

        this._gameServer = adapter;
        this._map = this._gameServer.Maps.First(m => m.Id == this.MapId);
        await base.OnInitializedAsync();
    }
}
